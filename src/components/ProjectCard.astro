---
import type { CollectionEntry } from "astro:content";
import { marked } from "marked";

type Props = { project: CollectionEntry<"projects"> };
const { project } = Astro.props as Props;

const aspectRatio = project.data.aspectRatio ?? "1 / 1.417";
const bodyDE = (project.data.body ?? project.body ?? "").toString();
const bodyEN = (project.data.body_en ?? "").toString();
---

<div
  class="project"
  style={`--image:url('${project.data.images?.[0]?.src ?? ""}'); --rect-aspect:${aspectRatio}`}
  data-name={project.data.name}
  aria-label={project.data.name}
>
  {project.data.kind === "text" && (
    <div class="text-block">
      <div class="titlebox">
        <p>{project.data.title}</p>
      </div>
      <div class="rectangle-content">
        <div class="lang-de" set:html={marked(bodyDE)}></div>
        <div class="lang-en" set:html={marked(bodyEN || bodyDE)}></div>
      </div>
    </div>
  )}

  {project.data.kind === "video" && project.data.video && (
    <div class="video-wrapper">
      <video
        class="project-video"
        muted
        loop
        playsinline
        data-start-time={project.data.startTime}
      >
        <source src={project.data.video} type="application/x-mpegURL" />
      </video>
      <button class="mute-toggle" aria-label="Toggle sound">unmute</button>
    </div>
  )}
</div>

<script type="module">
  import initVideo from "../scripts/initVideo.js";
  initVideo(); // ensure it targets ".project-video"
</script>

<style>
  .project {
    position: relative;
    background-image: var(--image);
    background-size: cover;
    background-position: center;
    aspect-ratio: var(--rect-aspect, 1 / 1.417);
    height: auto;
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 16px rgba(61,61,61,.2);
    overflow: hidden;
    flex-direction: column;
    width: var(--rect-width, 26.1rem);
  }

  .text-block {}
  .titlebox { min-height: 3rem; overflow: hidden; text-align: left; font-weight: bold; }

  .rectangle-content {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 2rem;
    padding-top: calc(2rem + 10%);
    box-sizing: border-box;
  }

  .video-wrapper { position: relative; width: 100%; height: 100%; }
  .mute-toggle {
    position: absolute; left: .5rem; bottom: .5rem; z-index: 1;
    background: rgba(0,0,0,.5); color: #fff; border: 0; padding: .25rem .5rem; cursor: pointer;
  }

  .images img, video { width: 100%; height: 100%; object-fit: cover; }
  video { display: block; }
</style>
